### 目标

用 MySQL 创建业务库、设置统一字符集与排序规则、创建并授权专用账号、完成连通性验证

### 推荐字符集与排序规则

优先使用 `utf8mb4` 与 `utf8mb4_0900_ai_ci`（MySQL 8 默认、排序与兼容性更好）
若需兼容老框架或 5.7，使用 `utf8mb4_unicode_ci` 或 `utf8mb4_general_ci`

### 建库与基础配置（MySQL 8.x）

```sql
-- 1) 创建数据库（幂等）
CREATE DATABASE IF NOT EXISTS `appdb`
  DEFAULT CHARACTER SET utf8mb4
  COLLATE utf8mb4_0900_ai_ci;

-- 2) 创建专用账号（按需要限制来源主机）
-- 仅本机
CREATE USER IF NOT EXISTS 'appuser'@'localhost' IDENTIFIED BY 'StrongPwd!123';
-- 或仅内网网段
-- CREATE USER IF NOT EXISTS 'appuser'@'10.0.%' IDENTIFIED BY 'StrongPwd!123';
-- 或任意主机（不推荐）
-- CREATE USER IF NOT EXISTS 'appuser'@'%' IDENTIFIED BY 'StrongPwd!123';

-- 3) 授权最小权限集（常见业务 DML + DDL 必需项）
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, ALTER, INDEX, CREATE TEMPORARY TABLES
ON `appdb`.*
TO 'appuser'@'localhost';

-- 4) 刷新权限（多数场景可省略）
FLUSH PRIVILEGES;

-- 5) 验证
SHOW DATABASES LIKE 'appdb';
SHOW GRANTS FOR 'appuser'@'localhost';
```

### 兼容 MySQL 5.7 的差异

```sql
-- 5.7 推荐排序规则
CREATE DATABASE IF NOT EXISTS `appdb`
  DEFAULT CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;

-- 5.7 常见认证写法
CREATE USER IF NOT EXISTS 'appuser'@'localhost' IDENTIFIED BY 'StrongPwd!123';
-- 若遇到驱动或老系统需要
-- CREATE USER 'appuser'@'localhost' IDENTIFIED WITH mysql_native_password BY 'StrongPwd!123';
```

### 命令行连接与快速验证

```bash
# 本机默认端口
mysql -uroot -p
# 指定 socket（macOS 常见）
mysql -uroot -p -S /tmp/mysql.sock
# 用业务账号验证并切库
mysql -uappuser -p -D appdb -e "SELECT 1;"
```

### 常见排障要点

1. 无法远程连通时检查 `bind-address` 与防火墙; 需允许对应来源主机并开放 3306
2. 权限生效异常时复查 `GRANT` 对象与主机匹配（`'user'@'host'` 必须一致）
3. 区分大小写问题由 `lower_case_table_names` 决定，跨平台迁移需提前约定
4. 生产避免使用 root 直连，业务账号按库授权并限制来源主机

### 可选：用 Java 创建数据库与授权（JDK8）

```java
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.sql.Statement;

/**
 * 概述: 以管理员连接 MySQL, 幂等创建数据库并配置字符集与排序规则
 * 功能: 创建库; 可扩展执行创建用户与授权; 简单连接校验
 * 使用示例:
 *   MySqlDbCreator.createDatabase(
 *       "jdbc:mysql://127.0.0.1:3306/?serverTimezone=Asia/Tokyo&useSSL=false&allowPublicKeyRetrieval=true",
 *       "root","rootPwd","appdb","utf8mb4","utf8mb4_0900_ai_ci");
 * 注意事项:
 *   1) 连接 URL 不选择具体库, 连接到实例层面
 *   2) 管理员账号需具备 CREATE DATABASE 权限
 *   3) 若需创建用户与授权, 可在 TODO 处追加 SQL
 * 入参:
 *   url 管理员连接串; user 管理员; pwd 管理员密码; dbName 目标库名; charset 字符集; collate 排序规则
 * 出参:
 *   无
 * 异常:
 *   SQLException 执行 SQL 或连接失败时抛出
 */
public final class MySqlDbCreator {
    private MySqlDbCreator() {}
    public static void createDatabase(String url, String user, String pwd,
                                      String dbName, String charset, String collate) throws SQLException {
        try (Connection conn = DriverManager.getConnection(url, user, pwd);
             Statement st = conn.createStatement()) {
            String createDb = String.format(
                "CREATE DATABASE IF NOT EXISTS `%s` DEFAULT CHARACTER SET %s COLLATE %s",
                dbName, charset, collate);
            st.executeUpdate(createDb);
            // TODO: 如需创建用户与授权:
            // st.executeUpdate("CREATE USER IF NOT EXISTS 'appuser'@'localhost' IDENTIFIED BY 'StrongPwd!123'");
            // st.executeUpdate("GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,ALTER,INDEX,CREATE TEMPORARY TABLES ON `" + dbName + "`.* TO 'appuser'@'localhost'");
        }
    }
}
```

### 生产实践建议

1. 一库一账号, 最小权限与最小可见网段
2. 统一使用 `utf8mb4` 与明确排序规则, 避免跨环境默认差异
3. 建库后立刻建基础对象与只读账号（如 BI 报表）并分权
4. 将建库脚本纳入版本控制与自动化（Flyway 或 Liquibase）
5. 定期校验权限漂移与弱口令扫描
